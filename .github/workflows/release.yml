name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.1.0)'
        required: true
        type: string

jobs:
  release:
    name: Build and Release
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Get version
      id: version
      shell: pwsh
      run: |
        if ($env:GITHUB_EVENT_NAME -eq 'workflow_dispatch') {
          $version = "${{ github.event.inputs.version }}"
        } else {
          $version = $env:GITHUB_REF -replace 'refs/tags/', ''
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "VERSION_NUM=$($version -replace '^v', '')" >> $env:GITHUB_OUTPUT

    - name: Restore dependencies
      run: dotnet restore WifiSurvey.sln

    - name: Build solution
      run: dotnet build WifiSurvey.sln --configuration Release --no-restore

    - name: Run tests
      run: dotnet test WifiSurvey.sln --configuration Release --no-build --verbosity normal

    - name: Publish self-contained executable
      shell: pwsh
      run: |
        dotnet publish WifiSurvey.csproj `
          --configuration Release `
          --runtime win-x64 `
          --self-contained true `
          -p:PublishSingleFile=true `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -p:EnableCompressionInSingleFile=true `
          -p:Version=${{ steps.version.outputs.VERSION_NUM }} `
          --output publish

    - name: Create installer package
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        $installerDir = "WifiSurvey-$version"

        # Create installer directory structure
        New-Item -ItemType Directory -Force -Path $installerDir

        # Copy executable
        Copy-Item "publish\WifiSurvey.exe" $installerDir\

        # Create Install.bat
        @"
        @echo off
        echo ========================================
        echo WifiSurvey Installation
        echo Version: $version
        echo ========================================
        echo.

        set "INSTALL_DIR=%ProgramFiles%\WifiSurvey"
        set "SHORTCUT_DIR=%ProgramData%\Microsoft\Windows\Start Menu\Programs"

        echo Creating installation directory...
        if not exist "%INSTALL_DIR%" mkdir "%INSTALL_DIR%"

        echo Copying files...
        copy /Y WifiSurvey.exe "%INSTALL_DIR%\"

        echo Creating Start Menu shortcut...
        powershell -Command "`$WshShell = New-Object -ComObject WScript.Shell; `$Shortcut = `$WshShell.CreateShortcut('%SHORTCUT_DIR%\WifiSurvey.lnk'); `$Shortcut.TargetPath = '%INSTALL_DIR%\WifiSurvey.exe'; `$Shortcut.WorkingDirectory = '%INSTALL_DIR%'; `$Shortcut.Description = 'WiFi Site Survey Tool'; `$Shortcut.Save()"

        echo Creating Desktop shortcut...
        powershell -Command "`$WshShell = New-Object -ComObject WScript.Shell; `$Shortcut = `$WshShell.CreateShortcut('%PUBLIC%\Desktop\WifiSurvey.lnk'); `$Shortcut.TargetPath = '%INSTALL_DIR%\WifiSurvey.exe'; `$Shortcut.WorkingDirectory = '%INSTALL_DIR%'; `$Shortcut.Description = 'WiFi Site Survey Tool'; `$Shortcut.Save()"

        echo.
        echo ========================================
        echo Installation Complete!
        echo ========================================
        pause
        "@ | Out-File -FilePath "$installerDir\Install.bat" -Encoding ASCII

        # Create README.txt
        @"
        WifiSurvey $version
        Professional WiFi Site Survey Tool

        INSTALLATION
        ============

        Method 1: Automated Installation (Recommended)
        -----------------------------------------------
        1. Right-click Install.bat
        2. Select "Run as administrator"
        3. Follow the prompts
        4. Launch from Start Menu or Desktop shortcut

        ⚠️  IMPORTANT: Administrator privileges required for WiFi adapter access

        Method 2: Portable Mode
        -----------------------
        1. Right-click WifiSurvey.exe
        2. Select "Run as administrator"
        3. No installation required

        USAGE
        =====
        1. Launch WifiSurvey (as administrator)
        2. Load floor plan: File → Open Floor Plan
        3. Click on floor plan to place measurement points
        4. View heatmap: Generate coverage visualization
        5. Save project: File → Save Survey
        6. Export data: File → Export to CSV

        SYSTEM REQUIREMENTS
        ===================
        - Windows 10 64-bit (1809+) or Windows 11
        - Wireless network adapter
        - Administrator privileges (required for WiFi API access)
        - No .NET installation required (self-contained)

        SUPPORT
        =======
        Documentation: https://github.com/azullus/WifiSurvey
        Issues: https://github.com/azullus/WifiSurvey/issues

        LICENSE
        =======
        MIT License - See LICENSE file or GitHub repository

        Copyright (c) 2026 CosmicBytez IT Operations Team
        "@ | Out-File -FilePath "$installerDir\README.txt" -Encoding UTF8

        # Create QUICKSTART.txt
        @"
        WifiSurvey $version - Quick Start Guide

        FIRST SITE SURVEY
        =================

        Step 1: Launch Application
        ---------------------------
        - Right-click WifiSurvey.exe → Run as administrator
        - Administrator privileges required for WiFi adapter access

        Step 2: Load Floor Plan
        ------------------------
        - Click File → Open Floor Plan
        - Select PNG, JPG, or BMP image of your floor plan
        - Floor plan will display in main window

        Step 3: Take Measurements
        --------------------------
        - Click on floor plan to place measurement point
        - WifiSurvey automatically scans WiFi networks
        - Each click records signal strength at that location
        - Move to different locations and repeat

        Step 4: View Coverage Heatmap
        ------------------------------
        - Click "Generate Heatmap" button
        - Color-coded visualization appears:
          * Green: Excellent signal (-30 to -50 dBm)
          * Yellow: Good signal (-50 to -60 dBm)
          * Orange: Fair signal (-60 to -70 dBm)
          * Red: Weak signal (-70 to -80 dBm)
          * Gray: Poor signal (< -80 dBm)

        Step 5: Save Your Work
        -----------------------
        - Click File → Save Survey
        - Saves all measurements and embedded floor plan
        - File format: .wifisurvey (JSON)

        Step 6: Export Data
        --------------------
        - Click File → Export to CSV
        - Opens in Excel for analysis
        - Includes SSID, signal strength, location coordinates

        TIPS FOR BEST RESULTS
        ======================
        - Take measurements at consistent height (e.g., desk level)
        - Cover all areas: offices, hallways, conference rooms
        - Measure near walls and corners where signal may be weak
        - Filter to specific SSID for targeted surveys
        - Export and archive data for before/after comparisons

        TROUBLESHOOTING
        ===============
        Problem: "No WiFi adapters found"
        Solution: Run as administrator, ensure WiFi adapter enabled

        Problem: Heatmap not generating
        Solution: Ensure floor plan loaded and measurement points placed

        Problem: No networks detected
        Solution: Disable airplane mode, check WiFi adapter status

        NEXT STEPS
        ==========
        - Experiment with different floor plans
        - Compare multiple SSIDs
        - Export data for reporting
        - Check documentation for advanced features

        Full documentation: https://github.com/azullus/WifiSurvey
        "@ | Out-File -FilePath "$installerDir\QUICKSTART.txt" -Encoding UTF8

        # Copy LICENSE if exists
        if (Test-Path "LICENSE") {
          Copy-Item "LICENSE" "$installerDir\LICENSE.txt"
        }

        # Create ZIP
        Compress-Archive -Path $installerDir -DestinationPath "WifiSurvey-$version-win-x64.zip" -Force

        # Generate checksum
        $hash = (Get-FileHash "WifiSurvey-$version-win-x64.zip" -Algorithm SHA256).Hash
        "$hash  WifiSurvey-$version-win-x64.zip" | Out-File -FilePath "WifiSurvey-$version-win-x64.zip.sha256" -Encoding ASCII

        echo "Package created: WifiSurvey-$version-win-x64.zip"
        echo "SHA256: $hash"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.VERSION }}
        name: WifiSurvey ${{ steps.version.outputs.VERSION }}
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          WifiSurvey-${{ steps.version.outputs.VERSION }}-win-x64.zip
          WifiSurvey-${{ steps.version.outputs.VERSION }}-win-x64.zip.sha256
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
